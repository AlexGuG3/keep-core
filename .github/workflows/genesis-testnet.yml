# This workflow initiates beacon genesis on testnet. The workflow should be
# manually dispatched after the `keep-core` contracts get deployed and
# kubernetes pods get rotated.
name: Beacon genesis

on:
  workflow_dispatch:
  push: # TODO: Just for testing. Remove before merging!

jobs:
  beacon-genesis:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./solidity
    steps:
      - uses: actions/checkout@v2

      - name: Load environment variables
        uses: keep-network/ci/actions/load-env-variables@v1
        with:
          environment: 'ropsten'

      - uses: actions/setup-node@v2
        with:
          node-version: "14.x"
          cache: "npm"
          cache-dependency-path: solidity/package-lock.json

      - run: npm ci

      - name: Install external keep-core contracts
        env:
          KEEP_CORE_VERSION: latest #TODO: Change to `ropsten`
        run: |
          mkdir external && cd "$_"
          npm init -y
          npm install --quiet --save-exact \
            @keep-network/keep-core@$KEEP_CORE_VERSION
          mkdir -p ../build/contracts
          cp -a node_modules/@keep-network/keep-core/artifacts/. ../build/contracts/
      
      - name: Submit genesis
        env:
          CHAIN_API_URL: ${{ secrets.KEEP_TEST_ETH_HOSTNAME_WS }}
          CONTRACT_OWNER_ACCOUNT_PRIVATE_KEY: |
            ${{ secrets.KEEP_TEST_ETH_CONTRACT_OWNER_PRIVATE_KEY }}
        run: npx truffle exec ./scripts/genesis.js â€”-network ${{ env.TRUFFLE_NETWORK }}
